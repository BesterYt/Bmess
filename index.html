<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Вход в мессенджер</title>
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: 50px auto; }
    input { display: block; margin: 10px 0; padding: 8px; width: 100%; }
    button { padding: 10px; width: 100%; }
    #passwordField, #registerBlock { display: none; }
  </style>
</head>
<body>

  <h2>Добро пожаловать</h2>

  <label for="code">Введите 6-значный код:</label>
  <input type="text" id="code" maxlength="6" placeholder="напр. 115783">

  <div id="passwordField">
    <label for="password">Пароль:</label>
    <input type="password" id="password" placeholder="Введите пароль">
    <button onclick="login()">Войти</button>
  </div>

  <div id="registerBlock">
    <label for="newPassword">Придумайте пароль:</label>
    <input type="password" id="newPassword" placeholder="Новый пароль">
    <button onclick="register()">Зарегистрироваться</button>
  </div>

  <p id="status"></p>

  <script>
    const API_URL = "https://bmessange.ivantimockin19.workers.dev";

    document.getElementById("code").addEventListener("input", async (e) => {
      const id = e.target.value;
      if (id.length === 6) {
        try {
          const exists = await apiCheckCode(id);
          document.getElementById("status").textContent = "";
          if (exists) {
            document.getElementById("passwordField").style.display = "block";
            document.getElementById("registerBlock").style.display = "none";
          } else {
            document.getElementById("passwordField").style.display = "none";
            document.getElementById("registerBlock").style.display = "block";
          }
        } catch (err) {
          document.getElementById("status").textContent = "Ошибка проверки кода.";
        }
      } else {
        document.getElementById("passwordField").style.display = "none";
        document.getElementById("registerBlock").style.display = "none";
        document.getElementById("status").textContent = "";
      }
    });

    async function apiCheckCode(id) {
      const res = await fetch(`${API_URL}/checkUser`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id }),
      });
      if (!res.ok) throw new Error("Ошибка сети");
      const data = await res.json();
      return data.exists;
    }

    function login() {
      const id = document.getElementById("code").value;
      const password = document.getElementById("password").value;
      localStorage.setItem("id", id);
      localStorage.setItem("password", password);
      window.location.href = "chat.html";
    }

    async function register() {
      const id = document.getElementById("code").value;
      const password = document.getElementById("newPassword").value;
      const exists = await apiCheckCode(id);
      if (exists) {
        alert("Этот ID уже зарегистрирован.");
        return;
      }
      // Простой прототип: добавляем пользователя вручную на сервере
      alert("Регистрация завершена. Запомните пароль.");
      localStorage.setItem("id", id);
      localStorage.setItem("password", password);
      window.location.href = "chat.html";
    }
  </script>

</body>
</html>
